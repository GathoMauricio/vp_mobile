<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content=" media-src *">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/alert_firma.css">
    <link rel="stylesheet" href="css/font.css">
    <link rel="stylesheet" href="css/index.css">
    <title>show_service</title>
</head>

<body>
    <!--Loading -->
    <div id="loading">
        <div id="content_loading">
            <center>
                &nbsp;&nbsp;&nbsp;
                <img src="img/logo.png" width="60" height="60">
                <br>
                <img src="img/loading.gif" width="60" height="60">
                <br>
                <label class="font-weight-bold" style="color:#2E86C1;">Espere...</label>
            </center>
        </div>
    </div>
    <!--End Loading-->
    <!--NAVBAR-->
    <nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index_service.html">
                <label for=""><span style="color:orange;"><i>V</i></span><span
                        style="color:green;"><i>P</i></span></label> Mobile
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="{{ __('Toggle navigation') }}">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">

                </ul>

                <ul class="navbar-nav ml-auto">
                    <!--   
                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>

                            <span style="color:red">{{ $contador_pendientes }}</span>

                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">

                            <a class="dropdown-item">
                                No hay servicios pendientes
                            </a>

                            <a class="dropdown-item" href="{{ route('show_service',$pendiente->id) }}">
                                <label class="font-weight-bold">{{ $pendiente->customer['name'] }} - {{ $pendiente->service_report }}</label>
                                <br>
                                {{ $pendiente->usuario_Final['name'] }} {{ $pendiente->usuario_Final['last_name1'] }} {{ $pendiente->usuario_Final['last_name2'] }}
                                <br>
                                <span style="color:#2E86C1;">{{ date_format(new \DateTime($pendiente->schedule), 'd-m-Y g:i A') }}</span>
                            </a>

                            <a class="dropdown-item" href="{{ route('index_pendiente') }}">
                                <center style="color:#2E86C1;">Mostrar todos los pendientes</center>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                            <input type="hidden" id="ruta_cargar_mensajes_push" value="{{ route('cargar_mensajes_push') }}">

                            <span id="span_num_bubble" style="color:red;" >{{ $contador_mensajes }}</span>

                        </a>
                        <input type="hidden" id="txt_img_loading" value="{{ asset('img/loading.gif') }}">
                        <div id="div_items_mensajes" class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">

                            <a style="background-color:#85C1E9;" class="dropdown-item" href="{{ route('open_message',[$mensaje->id,$mensaje->service_id]) }}">
                                <span class="icon {{$mensaje->icon}}" style="color:{{$mensaje->color}}"></span>
                                <label class="font-weight-bold">{{$mensaje->emisor['name']}} {{$mensaje->emisor['last_name1']}}</label> {!! $mensaje->mensaje !!}
                                <br>
                                <span class="float-right" style="color:white;">{{ date_format(new \DateTime($mensaje->created_at), 'd-m-Y g:i A') }}</span>
                                <br>
                            </a>

                            <a class="dropdown-item" href="{{ route('open_message',[$mensaje->id,$mensaje->service_id]) }}">
                                <span class="icon {{$mensaje->icon}}" style="color:{{$mensaje->color}}"></span>
                                <label class="font-weight-bold">{{$mensaje->emisor['name']}} {{$mensaje->emisor['last_name1']}}</label> {!! $mensaje->mensaje !!}
                                <br>
                                <span class="float-right" style="color:#2E86C1;">{{ date_format(new \DateTime($mensaje->created_at), 'd-m-Y g:i A') }}</span>
                                <br>
                            </a>

                            <a class="dropdown-item" href="{{ route('index_mensajes') }}">
                                <center style="color:#2E86C1;">Ver todos los mensajes</center>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link dropdown-toggle" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                            Servicios
                            <span class="caret"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{{ route('index_service') }}">
                                Lista de servicios
                            </a>

                            <a class="dropdown-item" href="{{ route('create_service') }}">
                                Nuevo servicio
                            </a>

                        </div>
                    </li>

                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link dropdown-toggle" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                            Usuarios
                            <span class="caret"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{{ route('index_user') }}">
                                Lista de usuarios
                            </a>
                            <a class="dropdown-item" href="{{ route('create_user') }}">
                                Nuevo usario
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link dropdown-toggle" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                            Clientes
                            <span class="caret"></span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="{{ route('index_customer') }}">
                                Lista de clientes
                            </a>
                            <a class="dropdown-item" href="{{ route('create_customer') }}">
                                Nuevo cliente
                            </a>
                        </div>
                    </li>
                -->
                    <li class="nav-item dropdown">
                        <a id="menu_nombre_usuario" class="nav-link dropdown-toggle" href="#" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                            <!--Se carga el nombre del usuario logeado-->
                            <span class="caret"></span>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <span class="dropdown-item" onclick="cerrarSesion();">
                                Cerrar sesión
                            </span>
                        </div>
                    </li>

                </ul>
            </div>
        </div>
    </nav>
    <br><br><br>
    <!--END NAVBAR-->
    <div class="container" id="contenedor">
        <div class="card">
            <div class="card-header">
                <table style="width:100%;">
                    <tr>
                        <td width="33%">
                            <button class="btn btn-secondary btn-block" style="color:white;"><span
                                    class="icon-share"></span> Status servicio</button>
                        </td>
                        <td width="33%">
                            <button class="btn btn-warning btn-block" style="color:white;"><span
                                    class="icon-clock"></span> Reagendar servicio</button>
                        </td>
                        <td width="33%">
                            <button class="btn btn-danger btn-block" style="color:white;"><span class="icon-bin"></span>
                                Cancelar servicio</button>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="card-body">
                <label class="font-weight-bold">Estatus: </label><br><span id="span_status_service">-</span>
                <br>
                <label class="font-weight-bold">Cliente/Razón social: </label><br><span id="span_customer_name">-</span>
                <br>
                <label class="font-weight-bold">Usuario final: </label><br><span id="span_final_user">-</span>
                <br>
                <label class="font-weight-bold">Tipo de servicio: </label><br><span id="span_service_type">-</span>
                <br>
                <label class="font-weight-bold">E-Mail de contacto: </label><br><span
                    id="span_final_user_email">-</span>
                <br>
                <label class="font-weight-bold">Teléfono de contacto: </label><br><span
                    id="span_final_user_phone">-</span>
                <br>
                <label class="font-weight-bold">Dirección de contacto: </label><br><span
                    id="span_final_user_address">-</span>
                <br>
                <label class="font-weight-bold">Mesa de ayuda: </label><br><span id="span_manager_name">-</span>
                <br>
                <label class="font-weight-bold">Empleado asignado: </label><br><span id="span_technical_name">-</span>
                <br>
                <label class="font-weight-bold">Fecha de asignación: </label><br><span id="span_schedule">-</span>
                <br>
                <label class="font-weight-bold">Descripción: </label><br><span id="span_description">-</span>
                <br>
                <label class="font-weight-bold">Solución: </label><br><span id="span_solution">-</span>
                <br>
                <label class="font-weight-bold">Observaciones: </label><br><span id="span_observations">-</span>
                <br>
                <label class="font-weight-bold">Firma: </label><br>
                <div id="div_firma_final_user" style="width:100%;"></div>
                <br><br><br><br>
            </div>
        </div>
    </div>

    <!--FOOTER-->
    <div class="footer">
        <table style="width:100%;">
            <tr>
                <td onclick="abrirMensajes()" width="25%"><span class="icon icon-bubble"
                        style="font-size:22px;"></span></td>
                <td onclick="abrirCamara()" width="25%"><span class="icon icon-camera" style="font-size:22px;"></span>
                </td>
                <!--
                <td onclick="abrirGaleria();" width="20%"><span class="icon icon-upload" style="font-size:22px;"></span>
                </td>
                -->
                <td onclick="verEvidencias()" width="25%"><span class="icon icon-image"
                        style="font-size:22px;"></span></td>
                <td onclick="firmar();" width="25%"><span id="span_final_user_firm" class="icon icon-pen"
                        style="font-size:22px;"></span></td>
            </tr>
        </table>
    </div>
    <!--END FOOTER-->

    <script src="cordova.js"></script>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/sweetalert.js"></script>
    <script src="js/index.js"></script>
    <script>
        var firm;
        $(document).ready(function () {
            loadingOn();
            $.ajax({
                url: ruta + 'show_service',
                data:
                {
                    api_token: window.localStorage.getItem('api_token'),
                    service_id: window.localStorage.getItem('service_id')
                },
                success: function (data) {
                    //console.log(JSON.stringify(data));
                    if (parseInt(data.status_service_id) >= 6) {
                        $("#span_status_service").text('Finalizado');
                    } else {
                        $("#span_status_service").text(data.status.status_service);
                    }
                    $("#span_customer_name").text(data.customer.name);
                    $("#span_final_user").text(data.usuario__final.name + ' ' + data.usuario__final.last_name1 + ' ' + data.usuario__final.last_name2);
                    $("#span_service_type").text(data.service_type.service_type);
                    $("#span_final_user_email").text(data.usuario__final.email);
                    $("#span_final_user_phone").text(data.usuario__final.phone);
                    $("#span_final_user_address").text(data.usuario__final.calle_numero + ' ' + data.usuario__final.cp + ' ' + data.usuario__final.asentamiento + ' ' + data.usuario__final.ciudad + ' ' + data.usuario__final.municipio + ' ' + data.usuario__final.estado);
                    $("#span_manager_name").text(data.manager.name + ' ' + data.manager.last_name1 + ' ' + data.manager.last_name2);
                    $("#span_technical_name").text(data.technical.name + ' ' + data.technical.last_name1 + ' ' + data.technical.last_name2);
                    $("#span_schedule").text(data.schedule + ' Hrs.');
                    $("#span_description").text(data.description);
                    $("#span_solution").text(data.solution);
                    $("#span_observations").text(data.observations);
                    firm = data.firm;
                    if (data.firm == null) {
                        $("#span_final_user_firm").css('color', 'white');
                    } else {
                        $("#span_final_user_firm").css('color', 'yellow');
                    }
                    //contador evidencias
                    //contador comentarios
                    loadingOff();
                },
                error: function (e) {
                    //console.log(JSON.stringify(e));
                    loadingOff();
                    toastError("Error al obtener los datos");
                }
            });


            $.ajax({
                url: ruta + 'show_firma',
                data:
                {
                    api_token: window.localStorage.getItem('api_token'),
                    service_id: window.localStorage.getItem('service_id')
                },
                success: function (data) {
                    //console.log(JSON.stringify(data.slice(-1)));
                    if (data.slice(-1) != '/') {
                        $("#div_firma_final_user").html("<img src='" + data + "' width='100%' height='200'>");
                    } else {
                        $("#div_firma_final_user").html("<center>No disponible aún.</center>");
                    }
                },
                error: function (e) {
                    //console.log(e.responseText);
                    $("body").html(e.responseText);
                    toastError("Error al obtener los datos");
                }
            });

        });
        function abrirMensajes() {
            window.location = 'index_mensajes.html';
        }
        function abrirCamara() {
            navigator.camera.cleanup();
            navigator.camera.getPicture(function (fileURI) {

            //Tomar descripción de la imagen
            swal({
                title: "Descripción",
                text: "",
                type: "input",
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Subir',
                closeOnConfirm: true,
                animation: "slide-from-top",
                inputPlaceholder: "Ingrese una descripción"
                },
                function(inputValue){
                if (inputValue === false) return false;

                if (inputValue === "") {
                    swal.showInputError("Descripción obligatoria");
                    return false
                }

                toastSuccess("Procesando...");
                /////////////OPCIONES DE TRANSFERENCIA AL SERVIDOR//////////////
                var options = new FileUploadOptions();
                options.fileKey = "imagen";
                options.fileName = fileURI.substr(fileURI.lastIndexOf('/') + 1);
                options.mimeType = "image/jpeg";
                var params = new Object();
                params.api_token = window.localStorage.getItem('api_token');
                params.service_id = window.localStorage.getItem('service_id');
                params.description = inputValue;
                options.params = params;
                var ft = new FileTransfer();
                ft.upload(fileURI, encodeURI(ruta + "store_evidence"),
                    function (data) {
                        //console.log("INFO DEL SERVER: " + JSON.stringify(data));
                        toastSuccess("Foto guardada");
                    },
                    function (error) {
                        toastError(JSON.stringify(error));
                        //console.log(JSON.stringify(error));
                    }, options);
            });

            }, function (error) {
                toastError(JSON.stringify(error));
                console.log(JSON.stringify(error));
            }, {
                quality: 20
            });
        }
        function abrirGaleria() {
            //navigator.camera.cleanup();
            navigator.camera.getPicture(function (fileURI) {

            //Tomar descripción de la imagen
            swal({
                title: "Descripción",
                text: "",
                type: "input",
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Subir',
                closeOnConfirm: true,
                animation: "slide-from-top",
                inputPlaceholder: "Ingrese una descripción"
                },
                function(inputValue){
                if (inputValue === false) return false;

                if (inputValue === "") {
                    swal.showInputError("Descripción obligatoria");
                    return false
                }

                toastSuccess("Procesando...");
                /////////////OPCIONES DE TRANSFERENCIA AL SERVIDOR//////////////
                var options = new FileUploadOptions();
                options.fileKey = "image";
                options.fileName = fileURI.substr(fileURI.lastIndexOf('/') + 1);
                options.mimeType = "image/png";
                var params = new Object();
                params.api_token = window.localStorage.getItem('api_token');
                params.service_id = window.localStorage.getItem('service_id');
                params.description = inputValue;
                options.params = params;
                var ft = new FileTransfer();
                ft.upload(fileURI, encodeURI(ruta + "upload_evidence"),
                    function (data) {
                        console.log("INFO DEL SERVER: " + JSON.stringify(data));
                        toastSuccess("Foto guardada");
                    },
                    function (error) {
                        toastError(JSON.stringify(error));
                        console.log(JSON.stringify(error));
                    }, options);
            });

            }, function (error) {
                toastError(JSON.stringify(error));
                console.log(JSON.stringify(error));
            }, {
                quality: 20,
                sourceType : 2
            });
        }
        function verEvidencias()
        {
            window.location = 'index_evidencia.html';
        }
        function firmar() {
            if (firm == null) {
                window.location = 'create_firma.html';
            } else {

                $.ajax({
                    url: ruta + 'show_firma',
                    data:
                    {
                        api_token: window.localStorage.getItem('api_token'),
                        service_id: window.localStorage.getItem('service_id')
                    },
                    success: function (data) {
                        //console.log(JSON.stringify(data));
                        swal({
                            html: true,
                            title: 'Aviso',
                            text: 'Ya existe una firma guardada<br><img src="' + data + '" width="60"><br>¿Desea sobreescribirla?',
                            confirmButtonText: 'Si',
                            showCancelButton: true,
                            cancelButtonText: 'No'
                        }, function () {
                            window.location = 'create_firma.html';
                        });
                        loadingOff();
                    },
                    error: function (e) {
                        //console.log(e.responseText);
                        $("body").html(e.responseText);
                        toastError("Error al obtener los datos");
                    }
                });
            }
        }
    </script>
    <style>
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
        }

        .footer table tr td {
            text-align: center;
            padding: 20px;
            background-color: black;
            color: white;
            border-left: solid 1px white;
            border-right: solid 1px white;
        }
    </style>
</body>

</html>